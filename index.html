<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីគ្រប់គ្រងការលក់ប្រចាំថ្ងៃ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .invoice-print-section {
            display: none;
        }
        @media print {
            body > *:not(.invoice-print-section) {
                display: none;
            }
            .invoice-print-section {
                display: block;
                font-family: sans-serif;
                color: #000;
                width: 80mm;
                padding: 5mm;
                box-sizing: border-box;
                margin: 0;
            }
        }
        /* Custom modal for alerts and confirmations */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .modal-buttons {
            margin-top: 16px;
            display: flex;
            justify-content: center;
            gap: 16px;
        }
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        .invoice-row:not(:first-child) .invoice-number-cell,
        .invoice-row:not(:first-child) .customer-info-cell {
            visibility: hidden;
        }
        /* Dark mode styles */
        body.dark-mode {
            background-color: #1a202c;
            color: #e2e8f0; /* Light gray for readable text */
        }
        body.dark-mode .bg-white {
            background-color: #2d3748;
        }
        body.dark-mode .bg-gray-100 {
            background-color: #1a202c;
        }
        body.dark-mode .bg-gray-50 {
            background-color: #2d3748;
        }
        body.dark-mode .bg-gray-200 {
            background-color: #4a5568;
        }
        body.dark-mode .text-gray-900,
        body.dark-mode .text-gray-700,
        body.dark-mode .text-gray-500,
        body.dark-mode .text-gray-800 {
            color: #e2e8f0; /* Light gray for readable text */
        }
        body.dark-mode .bg-white.hover\\:bg-gray-100:hover {
            background-color: #4a5568;
        }
        body.dark-mode .hover\\:bg-gray-100:hover {
             background-color: #4a5568;
        }
        body.dark-mode .bg-indigo-50 {
            background-color: #2a384a;
        }
        body.dark-mode .bg-green-50 {
            background-color: #1f3b33;
        }
        body.dark-mode .bg-yellow-50 {
            background-color: #3b361a;
        }
        body.dark-mode .text-indigo-700, body.dark-mode .text-indigo-800,
        body.dark-mode .text-green-700, body.dark-mode .text-green-800,
        body.dark-mode .text-yellow-700, body.dark-mode .text-yellow-800 {
            color: #e2e8f0;
        }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        body.dark-mode input::placeholder, body.dark-mode select::placeholder, body.dark-mode textarea::placeholder {
            color: #a0aec0;
        }
        body.dark-mode .modal-content {
            background-color: #2d3748;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Modal for messages -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg font-semibold text-gray-800"></p>
            <div class="modal-buttons">
                <button id="modalOkBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300">យល់ព្រម</button>
            </div>
        </div>
    </div>

    <!-- Modal for confirmations -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <p id="confirmMessage" class="text-lg font-semibold text-gray-800"></p>
            <div class="modal-buttons">
                <button id="confirmYesBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-300">បាទ/ចាស</button>
                <button id="confirmNoBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300">ទេ</button>
            </div>
        </div>
    </div>

    <!-- Loading message container -->
    <div id="loadingView" class="loading-container">
        <div class="flex flex-col items-center p-8 bg-white rounded-lg shadow-lg">
            <div class="w-16 h-16 border-4 border-t-4 border-gray-200 border-solid rounded-full animate-spin border-indigo-500"></div>
            <p class="mt-4 text-gray-700 font-semibold">កំពុងផ្ទុកទិន្នន័យ...</p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="mainApp" class="flex w-full flex-col hidden">
        <!-- Top Navigation Bar -->
        <nav class="bg-gray-900 text-white p-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="text-xl font-bold">កម្មវិធីគ្រប់គ្រងការលក់</div>
                <div class="flex items-center space-x-2">
                    <button id="dashboardNavBtn" class="px-4 py-2 rounded-md font-medium text-gray-700 bg-white hover:bg-gray-100 transition duration-300 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
                        <span class="whitespace-nowrap">ផ្ទាំងគ្រប់គ្រង</span>
                    </button>
                    <button id="customerInfoNavBtn" class="px-4 py-2 rounded-md font-medium text-gray-700 hover:bg-gray-100 transition duration-300 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zm-1.5 6a4.5 4.5 0 00-4.5 4.5V18h9v-1.5A4.5 4.5 0 0011.5 12z" clip-rule="evenodd" fill-rule="evenodd" /></svg>
                        <span class="whitespace-nowrap">ព័ត៌មានអតិថិជន</span>
                    </button>
                    <button id="historyNavBtn" class="px-4 py-2 rounded-md font-medium text-gray-700 hover:bg-gray-100 transition duration-300 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2.75 9a.75.75 0 000 1.5h14.5a.75.75 0 000-1.5H2.75z" fill-rule="evenodd" clip-rule="evenodd" /></svg>
                        <span class="whitespace-nowrap">មើលប្រវត្តិទិន្នន័យ</span>
                    </button>
                </div>
            </div>
            <button id="themeToggleBtn" class="p-2 rounded-md hover:bg-gray-200 transition duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" id="lightIcon" class="h-6 w-6 text-gray-200" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg xmlns="http://www.w3.org/2000/svg" id="darkIcon" class="h-6 w-6 text-gray-200 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0015.354 20.354 9.003 9.003 0 0020.354 15.354z" /></svg>
            </button>
        </nav>
        
        <!-- Content Area -->
        <div id="contentArea" class="p-4 flex-grow">
            <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8 space-y-8">
                <div class="flex justify-between items-center mb-6">
                    <div class="text-center w-full">
                         <h1 class="text-3xl font-bold text-gray-800">កម្មវិធីគ្រប់គ្រងការលក់ Online</h1>
                         <p class="text-gray-500 mt-2">កត់ត្រា និងបោះពុម្ពវិក្កយបត្រលក់</p>
                    </div>
                </div>
                <!-- Dashboard View -->
                <div id="dashboardView" class="hidden">
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">ផ្ទាំងគ្រប់គ្រង</h2>
                        <div class="mb-6 flex space-x-4">
                            <div>
                                <label for="startDate" class="block text-sm font-medium text-gray-700">ចាប់ពីថ្ងៃ</label>
                                <input type="date" id="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                            <div>
                                <label for="endDate" class="block text-sm font-medium text-gray-700">ដល់ថ្ងៃ</label>
                                <input type="date" id="endDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-indigo-50 p-6 rounded-lg shadow-sm">
                                <p class="text-sm text-indigo-700 font-medium">ចំនួនការលក់សរុប</p>
                                <p id="totalSalesCount" class="text-3xl font-bold text-indigo-800 mt-1">0</p>
                            </div>
                            <div class="bg-green-50 p-6 rounded-lg shadow-sm">
                                <p class="text-sm text-green-700 font-medium">ចំណូលសរុប (ដុល្លារ)</p>
                                <p id="totalRevenue" class="text-3xl font-bold text-green-800 mt-1">$0.00</p>
                            </div>
                            <div class="bg-yellow-50 p-6 rounded-lg shadow-sm">
                                <p class="text-sm text-yellow-700 font-medium">ចំណូលពីសេវាដឹក</p>
                                <p id="totalDeliveryFee" class="text-3xl font-bold text-yellow-800 mt-1">$0.00</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Sales Form View (now "ព័ត៌មានអតិថិជន") -->
                <div id="customerInfoView" class="hidden">
                    <!-- Customer Information Form -->
                    <div class="bg-gray-50 rounded-lg p-6 space-y-4">
                        <h2 class="text-xl font-semibold text-gray-700">ព័ត៌មានអតិថិជន</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="customerName" class="block text-sm font-medium text-gray-700">ឈ្មោះអតិថិជន</label>
                                <input type="text" id="customerName" placeholder="ដូចជា: កញ្ញា សុភា" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                            <div>
                                <label for="customerPhone" class="block text-sm font-medium text-gray-700">លេខទូរស័ព្ទ</label>
                                <input type="text" id="customerPhone" placeholder="012 345 678" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                            <div class="md:col-span-1">
                                <label for="customerAddress" class="block text-sm font-medium text-gray-700">អាសយដ្ឋាន</label>
                                <input type="text" id="customerAddress" placeholder="ភូមិ X ឃុំ Y" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h3 class="text-sm font-medium text-gray-700">ជម្រើសហាង</h3>
                            <div class="mt-2 flex items-center space-x-4">
                                <div class="flex items-center">
                                    <input id="ccrOnlineCheckbox" type="checkbox" name="store" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="ccrOnlineCheckbox" class="ml-2 block text-sm text-gray-900">CCR Online Store</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="yl99CcrCheckbox" type="checkbox" name="store" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="yl99CcrCheckbox" class="ml-2 block text-sm text-gray-900">YL 99CCR</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="ccr168Checkbox" type="checkbox" name="store" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="ccr168Checkbox" class="ml-2 block text-sm text-gray-900">CCR168</label>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h3 class="text-sm font-medium text-gray-700">ជម្រើសសម្រាប់ការដឹកជញ្ជូន</h3>
                            <div class="mt-2 flex items-center space-x-4">
                                <div class="flex items-center">
                                    <input id="vetRadio" type="radio" name="deliveryOption" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="vetRadio" class="ml-2 block text-sm text-gray-900">VET</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="jtRadio" type="radio" name="deliveryOption" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="jtRadio" class="ml-2 block text-sm text-gray-900">J&T</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="phnompenhRadio" type="radio" name="deliveryOption" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="phnompenhRadio" class="ml-2 block text-sm text-gray-900">ភ្នំពេញ</label>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h3 class="text-sm font-medium text-gray-700">ជម្រើសការទូទាត់</h3>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center space-x-4">
                                    <div class="flex items-center">
                                        <input id="acCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="acCheckbox" class="ml-2 block text-sm text-gray-900">AC</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="abaCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="abaCheckbox" class="ml-2 block text-sm text-gray-900">ABA</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="wingCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="wingCheckbox" class="ml-2 block text-sm text-gray-900">Wing</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input id="trueEmoneyCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="trueEmoneyCheckbox" class="ml-2 block text-sm text-gray-900">True Emoney</label>
                                    </div>
                                </div>
                                <div>
                                    <label for="paymentNotes" class="block text-sm font-medium text-gray-700 mt-2">កំណត់សម្គាល់បន្ថែម</label>
                                    <input type="text" id="paymentNotes" placeholder="ដាក់លេខTxd ..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h3 class="text-sm font-medium text-gray-700">សេវាដឹក</h3>
                            <div class="mt-2">
                                <label for="deliveryFee" class="block text-sm font-medium text-gray-700">តម្លៃសេវាដឹក (ដុល្លារ)</label>
                                <input type="number" id="deliveryFee" placeholder="0.00" min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                        </div>
                    </div>

                    <!-- Input Form -->
                    <div class="bg-gray-50 rounded-lg p-6 space-y-4">
                        <h2 class="text-xl font-semibold text-gray-700">បញ្ចូលព័ត៌មានការលក់</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="col-span-1 md:col-span-2">
                                <label for="itemName" class="block text-sm font-medium text-gray-700">ឈ្មោះទំនិញ</label>
                                <input type="text" id="itemName" placeholder="ដូចជា: ក្រែមលាបមុខ" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                            <div>
                                <label for="itemQuantity" class="block text-sm font-medium text-gray-700">ចំនួន</label>
                                <input type="number" id="itemQuantity" value="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                            <div>
                                <label for="itemPrice" class="block text-sm font-medium text-gray-700">តម្លៃ (ដុល្លារ)</label>
                                <input type="number" id="itemPrice" placeholder="0.00" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                            </div>
                        </div>
                        <div class="flex justify-end mt-4 space-x-2">
                            <button id="addItemBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 shadow-sm">
                                បន្ថែមទំនិញ
                            </button>
                            <button id="clearFormBtn" class="px-4 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 transition duration-300 shadow-sm">
                                ជម្រះទិន្នន័យ
                            </button>
                        </div>
                    </div>

                    <!-- Sales Table -->
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">បញ្ជីការលក់</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ល.រ
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ឈ្មោះទំនិញ
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ចំនួន
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            តម្លៃ
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ផលបូក
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            លុប
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="salesList" class="bg-white divide-y divide-gray-200">
                                    <!-- Sales items will be inserted here by JavaScript -->
                                </tbody>
                                <tfoot>
                                    <tr class="bg-gray-50">
                                        <td colspan="4" class="px-6 py-4 whitespace-nowrap text-right text-base font-bold text-gray-900">
                                            សរុប:
                                        </td>
                                        <td id="totalAmount" class="px-6 py-4 whitespace-nowrap text-left text-base font-bold text-gray-900">
                                            $0.00
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Action Buttons for Customer Info View -->
                    <div class="flex justify-center md:justify-end space-x-4 mt-6">
                        <button id="printBtn" class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-300 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v9a2 2 0 002 2h12a2 2 0 002-2v-9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm2 5V4h6v5H7zm6 3H7v4h6v-4z" clip-rule="evenodd" />
                            </svg>
                            បោះពុម្ពវិក្កយបត្រ
                        </button>
                        <button id="clearCurrentListBtn" class="px-6 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300 shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-8a1 1 0 112 0v5a1 1 0 11-2 0v-5z" clip-rule="evenodd" />
                            </svg>
                            ជម្រះបញ្ជីបច្ចុប្បន្ន
                        </button>
                    </div>
                </div>

                <!-- Data History View -->
                <div id="historyView" class="hidden">
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-700">ប្រវត្តិទិន្នន័យ</h2>
                        </div>
                         <div class="mb-4">
                            <label for="searchQuery" class="block text-sm font-medium text-gray-700">ស្វែងរក</label>
                            <input type="text" id="searchQuery" placeholder="ស្វែងរកតាមលេខវិក្កយបត្រ ឈ្មោះអតិថិជន លេខទូរស័ព្ទ ឬអាសយដ្ឋាន..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            លេខវិក្កយបត្រ
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ឈ្មោះអតិថិជន
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            លេខទូរស័ព្ទ
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            អាសយដ្ឋាន
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ឈ្មោះទំនិញ
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ចំនួន
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            តម្លៃ
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ផលបូក
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            ជម្រើស
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="historyList" class="bg-white divide-y divide-gray-200">
                                    <!-- History items will be inserted here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Action Buttons for History View -->
                        <div class="flex justify-center md:justify-end space-x-4 mt-6">
                            <button id="downloadDataBtn" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300 shadow-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                                ទាញយកទិន្នន័យ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');
        
        // --- Firebase Setup ---
        // Placeholder for Firebase configuration. You must replace this with your project's config.
        // Go to your Firebase project settings -> Project settings -> General -> Your apps -> select your app
        // Copy the "Firebase SDK snippet" and paste it here.
        const firebaseConfig = {
            apiKey: "AIzaSyDx53uucVLn2qZpKHgm4Zfmn0oq7IqWKDE",
            authDomain: "my-online-sale-re.firebaseapp.com",
            projectId: "my-online-sale-re",
            storageBucket: "my-online-sale-re.firebasestorage.app",
            messagingSenderId: "897696868123",
            appId: "1:897696868123:web:a1c31ba969f90ababb15be",
            measurementId: "G-RP5KG6GY4Y"
        };
        const appId = firebaseConfig.projectId;

        let db = null;
        let unsubscribe = null;
        let historyInvoices = []; 
        let currentInvoiceItems = [];

        const mainApp = document.getElementById('mainApp');
        const loadingView = document.getElementById('loadingView');
        const sideMenu = document.getElementById('sideMenu');
        const contentArea = document.getElementById('contentArea');
        const menuItems = document.getElementById('menuItems');
        const collapseIcon = document.getElementById('collapseIcon');
        const expandIcon = document.getElementById('expandIcon');
        
        let app = null;
        try {
            if (firebaseConfig.projectId && firebaseConfig.apiKey && firebaseConfig.authDomain) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
            } else {
                throw new Error("Firebase configuration is missing. Please update firebaseConfig with your project's details.");
            }
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            document.getElementById('loadingView').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            document.getElementById('contentArea').innerHTML = `
                <div class="max-w-xl mx-auto bg-white rounded-xl shadow-lg p-8 text-center text-red-600">
                    <p class="text-xl font-bold mb-4">មានបញ្ហាក្នុងការភ្ជាប់ Firebase!</p>
                    <p>សូមបើកកូដរបស់អ្នក ហើយបន្លែមព័ត៌មាន <span class="font-mono">firebaseConfig</span> របស់គម្រោងអ្នក។</p>
                </div>
            `;
        }

        async function loadPublicData() {
            loadingView.style.display = 'flex';
            mainApp.style.display = 'none';
            
            try {
                const invoicesCollectionRef = collection(db, `artifacts/${appId}/public/data/invoices`);
                const q = query(invoicesCollectionRef);
                unsubscribe = onSnapshot(q, (querySnapshot) => {
                    historyInvoices = [];
                    querySnapshot.forEach((doc) => {
                        historyInvoices.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderHistoryList();
                    updateDashboard();
                    
                    loadingView.style.display = 'none';
                    mainApp.style.display = 'flex';
                });
            } catch (error) {
                console.error("Firestore error:", error);
                loadingView.style.display = 'none';
                mainApp.style.display = 'flex';
                showMessage('មានបញ្ហាក្នុងការផ្ទុកទិន្នន័យ។ សូមព្យាយាមម្ដងទៀត។');
            }
        }
        
        if (app) {
            loadPublicData();
        }

        // --- Modal/Message Box Functions ---
        const messageModal = document.getElementById('messageModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalOkBtn = document.getElementById('modalOkBtn');
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');
        let confirmationCallback = null;

        const showMessage = (message) => {
            modalMessage.textContent = message;
            messageModal.style.display = 'flex';
        };

        const showConfirmation = (message, callback) => {
            confirmMessage.textContent = message;
            confirmationCallback = callback;
            confirmModal.style.display = 'flex';
        };

        if(modalOkBtn) {
            modalOkBtn.addEventListener('click', () => {
                messageModal.style.display = 'none';
            });
        }

        if(confirmYesBtn) {
            confirmYesBtn.addEventListener('click', () => {
                confirmModal.style.display = 'none';
                if (confirmationCallback) {
                    confirmationCallback(true);
                }
            });
        }
        if(confirmNoBtn) {
            confirmNoBtn.addEventListener('click', () => {
                confirmModal.style.display = 'none';
                if (confirmationCallback) {
                    confirmationCallback(false);
                }
            });
        }


        // Get all necessary HTML elements
        const dashboardView = document.getElementById('dashboardView');
        const customerInfoView = document.getElementById('customerInfoView');
        const historyView = document.getElementById('historyView');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        const customerNameInput = document.getElementById('customerName');
        const customerPhoneInput = document.getElementById('customerPhone');
        const customerAddressInput = document.getElementById('customerAddress');
        const ccrOnlineCheckbox = document.getElementById('ccrOnlineCheckbox');
        const yl99CcrCheckbox = document.getElementById('yl99CcrCheckbox');
        const ccr168Checkbox = document.getElementById('ccr168Checkbox');
        const vetRadio = document.getElementById('vetRadio');
        const jtRadio = document.getElementById('jtRadio');
        const phnompenhRadio = document.getElementById('phnompenhRadio');
        const acCheckbox = document.getElementById('acCheckbox');
        const abaCheckbox = document.getElementById('abaCheckbox');
        const wingCheckbox = document.getElementById('wingCheckbox');
        const trueEmoneyCheckbox = document.getElementById('trueEmoneyCheckbox');
        const paymentNotesInput = document.getElementById('paymentNotes');
        const deliveryFeeInput = document.getElementById('deliveryFee');
        const itemNameInput = document.getElementById('itemName');
        const itemQuantityInput = document.getElementById('itemQuantity');
        const itemPriceInput = document.getElementById('itemPrice');
        const addItemBtn = document.getElementById('addItemBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const salesListBody = document.getElementById('salesList');
        const historyListBody = document.getElementById('historyList');
        const totalAmountDisplay = document.getElementById('totalAmount');
        const printBtn = document.getElementById('printBtn');
        const clearCurrentListBtn = document.getElementById('clearCurrentListBtn');
        const downloadDataBtn = document.getElementById('downloadDataBtn');
        const searchQueryInput = document.getElementById('searchQuery');
        
        const totalSalesCountDisplay = document.getElementById('totalSalesCount');
        const totalRevenueDisplay = document.getElementById('totalRevenue');
        const totalDeliveryFeeDisplay = document.getElementById('totalDeliveryFee');

        // Navigation buttons
        const dashboardNavBtn = document.getElementById('dashboardNavBtn');
        const customerInfoNavBtn = document.getElementById('customerInfoNavBtn');
        const historyNavBtn = document.getElementById('historyNavBtn');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const lightIcon = document.getElementById('lightIcon');
        const darkIcon = document.getElementById('darkIcon');


        // Function to handle exclusive checkbox selection for store names
        const handleStoreSelection = (selectedCheckbox) => {
            [ccrOnlineCheckbox, yl99CcrCheckbox, ccr168Checkbox].forEach(checkbox => {
                if (checkbox !== selectedCheckbox) {
                    checkbox.checked = false;
                }
            });
        };
        // Function to handle exclusive checkbox selection for payment methods
        const handlePaymentSelection = (selectedCheckbox) => {
            [acCheckbox, abaCheckbox, wingCheckbox, trueEmoneyCheckbox].forEach(checkbox => {
                if (checkbox !== selectedCheckbox) {
                    checkbox.checked = false;
                }
            });
        };

        if (ccrOnlineCheckbox) ccrOnlineCheckbox.addEventListener('change', () => handleStoreSelection(ccrOnlineCheckbox));
        if (yl99CcrCheckbox) yl99CcrCheckbox.addEventListener('change', () => handleStoreSelection(yl99CcrCheckbox));
        if (ccr168Checkbox) ccr168Checkbox.addEventListener('change', () => handleStoreSelection(ccr168Checkbox));
        if (acCheckbox) acCheckbox.addEventListener('change', () => handlePaymentSelection(acCheckbox));
        if (abaCheckbox) abaCheckbox.addEventListener('change', () => handlePaymentSelection(abaCheckbox));
        if (wingCheckbox) wingCheckbox.addEventListener('change', () => handlePaymentSelection(wingCheckbox));
        if (trueEmoneyCheckbox) trueEmoneyCheckbox.addEventListener('change', () => handlePaymentSelection(trueEmoneyCheckbox));
        
        // Autocomplete customer data from history
        let debounceTimer;
        customerPhoneInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const phoneNumber = customerPhoneInput.value.trim();
                if (phoneNumber.length > 5) {
                    const latestInvoice = historyInvoices.find(invoice => (invoice.customerPhone || '').trim() === phoneNumber);
                    if (latestInvoice) {
                        showConfirmation("អតិថិជនចាស់ តើអ្នកចង់អោយកម្មវិធីបំពេញជំនួសទេ", (result) => {
                            if (result) {
                                fillCustomerData(latestInvoice);
                            }
                        });
                    }
                }
            }, 500);
        });

        const fillCustomerData = (invoice) => {
            customerNameInput.value = invoice.customerName || '';
            customerAddressInput.value = invoice.customerAddress || '';
            
            // Uncheck all delivery options
            vetRadio.checked = false;
            jtRadio.checked = false;
            phnompenhRadio.checked = false;
            
            // Check the correct delivery option
            if (invoice.deliveryOption === 'VET') vetRadio.checked = true;
            else if (invoice.deliveryOption === 'J&T') jtRadio.checked = true;
            else if (invoice.deliveryOption === 'ភ្នំពេញ') phnompenhRadio.checked = true;
        };

        // Function to add a new item to the local sales list
        const addItem = () => {
            const name = itemNameInput.value.trim();
            const quantity = parseFloat(itemQuantityInput.value);
            const price = parseFloat(itemPriceInput.value);
            const deliveryFee = parseFloat(deliveryFeeInput.value) || 0;

            if (!name || isNaN(quantity) || isNaN(price) || quantity <= 0 || price <= 0) {
                showMessage('សូមបញ្ចូលព័ត៌មានទំនិញឲ្យបានគ្រប់គ្រាន់ និងត្រឹមត្រូវ។');
                return;
            }

            const total = quantity * price;
            currentInvoiceItems.push({
                name,
                quantity,
                price,
                total,
                customerName: customerNameInput.value.trim(),
                customerPhone: customerPhoneInput.value.trim(),
                customerAddress: customerAddressInput.value.trim(),
                deliveryOption: getDeliveryOptions(),
                paymentOption: getPaymentOptions(),
                paymentNotes: paymentNotesInput.value.trim(),
                deliveryFee: deliveryFee,
                storeName: getStoreName(),
                timestamp: new Date()
            });
            
            // Clear the input fields after successful addition
            itemNameInput.value = '';
            itemQuantityInput.value = '1';
            itemPriceInput.value = '';
            itemNameInput.focus();
            
            renderSalesList();
        };

        // Function to render the current sales list table
        const renderSalesList = () => {
            salesListBody.innerHTML = '';
            let totalAmount = 0;
            currentInvoiceItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${item.price.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${item.total.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="delete-item-local text-red-600 hover:text-red-900" data-index="${index}">លុប</button>
                    </td>
                `;
                salesListBody.appendChild(row);
                totalAmount += item.total;
            });
            
            const deliveryFee = parseFloat(deliveryFeeInput.value) || 0;
            totalAmountDisplay.textContent = `$${(totalAmount + deliveryFee).toFixed(2)}`;

            // Add event listeners to the new delete buttons
            document.querySelectorAll('.delete-item-local').forEach(button => {
                button.addEventListener('click', deleteLocalItem);
            });
        };
        
        // Function to delete an item from the local array
        const deleteLocalItem = (e) => {
            const index = e.target.dataset.index;
            currentInvoiceItems.splice(index, 1);
            renderSalesList();
        };
        
        // Function to render the history list table
        const renderHistoryList = () => {
            const query = searchQueryInput.value.toLowerCase().trim();
            
            // Sort invoices by timestamp descending to ensure the most recent is at the top
            const sortedInvoices = [...historyInvoices].sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
            
            historyListBody.innerHTML = '';

            const filteredInvoices = sortedInvoices.filter((invoice) => {
                const customerName = (invoice.customerName || '').toLowerCase();
                const customerPhone = (invoice.customerPhone || '').toLowerCase();
                const customerAddress = (invoice.customerAddress || '').toLowerCase();
                const invoiceNumber = 'c' + (sortedInvoices.length - sortedInvoices.indexOf(invoice)).toString().padStart(7, '0');

                return invoiceNumber.includes(query) ||
                       customerName.includes(query) ||
                       customerPhone.includes(query) ||
                       customerAddress.includes(query);
            });
            
            if (filteredInvoices.length === 0 && query.length > 0) {
                 historyListBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="px-6 py-4 text-center text-gray-500">
                            រកមិនឃើញលទ្ធផលសម្រាប់ "${searchQueryInput.value}"
                        </td>
                    </tr>
                `;
                 return;
            }

            filteredInvoices.forEach((invoice, index) => {
                const invoiceNumber = 'C' + (sortedInvoices.length - sortedInvoices.indexOf(invoice)).toString().padStart(7, '0');
                const invoiceDate = invoice.timestamp.toDate().toLocaleDateString('km-KH');
                const invoiceTime = invoice.timestamp.toDate().toLocaleTimeString('km-KH', { hour: '2-digit', minute: '2-digit' });

                invoice.items.forEach((item, itemIndex) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    if (itemIndex === 0) {
                        row.classList.add('invoice-row');
                    }
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 invoice-number-cell">
                            ${invoiceNumber}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 customer-info-cell">
                            ${invoice.customerName || 'N/A'}<br>
                            <span class="text-xs text-gray-500">${invoiceDate} (${invoiceTime})</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 customer-info-cell">${invoice.customerPhone || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 customer-info-cell">${invoice.customerAddress || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${item.price.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${item.total.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex items-center gap-2">
                             <button class="reprint-invoice text-blue-600 hover:text-blue-900" data-doc-id="${invoice.id}" title="បោះពុម្ពឡើងវិញ">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M5 4v3H4a2 2 0 00-2 2v9a2 2 0 002 2h12a2 2 0 002-2v-9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" />
                                </svg>
                            </button>
                            <button class="delete-item-db text-red-600 hover:text-red-900" data-doc-id="${invoice.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </td>
                    `;
                    historyListBody.appendChild(row);
                });
            });

            document.querySelectorAll('.delete-item-db').forEach(button => {
                button.addEventListener('click', deleteItemFromDB);
            });
            document.querySelectorAll('.reprint-invoice').forEach(button => {
                button.addEventListener('click', reprintInvoice);
            });
        };
        
        // Function to delete an item from the database
        const deleteItemFromDB = async (e) => {
            const docId = e.target.dataset.docId;
            try {
                showConfirmation('តើអ្នកពិតជាចង់លុបវិក្កយបត្រនេះមែនទេ? ការលុបនេះមិនអាចយកមកវិញបានទេ។', async (result) => {
                    if (result) {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/invoices`, docId));
                        showMessage('បានលុបវិក្កយបត្រដោយជោគជ័យ។');
                    }
                });
            } catch (e) {
                console.error("Error removing document: ", e);
                showMessage('មានបញ្ហាក្នុងការលុបទិន្នន័យ។ សូមព្យាយាមម្ដងទៀត។');
            }
        };

        // Function to update all dashboard metrics
        const updateDashboard = () => {
            let totalSalesCount = 0;
            let totalRevenue = 0;
            let totalDeliveryFee = 0;
            
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            const filteredInvoices = historyInvoices.filter(invoice => {
                const invoiceDate = invoice.timestamp.toDate();
                let matchesDate = true;
                if (startDate && invoiceDate < startDate) {
                    matchesDate = false;
                }
                if (endDate) {
                    const endOfDay = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate(), 23, 59, 59);
                    if (invoiceDate > endOfDay) {
                        matchesDate = false;
                    }
                }
                return matchesDate;
            });

            filteredInvoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    totalSalesCount++;
                    totalRevenue += item.total;
                });
                totalDeliveryFee += invoice.deliveryFee;
            });
            
            totalSalesCountDisplay.textContent = totalSalesCount;
            totalRevenueDisplay.textContent = `$${totalRevenue.toFixed(2)}`;
            totalDeliveryFeeDisplay.textContent = `$${totalDeliveryFee.toFixed(2)}`;
        };
        
        // Helper functions for getting checkbox values
        const getStoreName = () => {
            if (ccrOnlineCheckbox.checked) return 'CCR Online Store';
            if (yl99CcrCheckbox.checked) return 'YL 99CCR';
            if (ccr168Checkbox.checked) return 'CCR168';
            return 'វិក្កយបត្រ';
        };

        const getDeliveryOptions = () => {
            if (vetRadio.checked) return 'VET';
            if (jtRadio.checked) return 'J&T';
            if (phnompenhRadio.checked) return 'ភ្នំពេញ';
            return 'មិនបានជ្រើសរើស';
        };

        const getPaymentOptions = () => {
            let options = [];
            if (acCheckbox.checked) options.push('AC');
            if (abaCheckbox.checked) options.push('ABA');
            if (wingCheckbox.checked) options.push('Wing');
            if (trueEmoneyCheckbox.checked) options.push('True Emoney');
            return options.join(', ') || 'មិនបានជ្រើសរើស';
        };

        // Function to clear input forms
        const clearFormInputs = () => {
            customerNameInput.value = '';
            customerPhoneInput.value = '';
            customerAddressInput.value = '';
            vetRadio.checked = false;
            jtRadio.checked = false;
            phnompenhRadio.checked = false;
            ccrOnlineCheckbox.checked = false;
            yl99CcrCheckbox.checked = false;
            ccr168Checkbox.checked = false;
            acCheckbox.checked = false;
            abaCheckbox.checked = false;
            wingCheckbox.checked = false;
            trueEmoneyCheckbox.checked = false;
            paymentNotesInput.value = '';
            deliveryFeeInput.value = '';
            itemNameInput.value = '';
            itemQuantityInput.value = '1';
            itemPriceInput.value = '';
            itemNameInput.focus();
        };

        // Function to save invoice to database and then clear the local list
        const saveInvoiceToFirestoreAndPrint = async () => {
            if (currentInvoiceItems.length === 0) {
                showMessage('សូមបន្ថែមទំនិញយ៉ាងតិចមួយមុខដើម្បីបោះពុម្ព។');
                return;
            }
            
            const customerName = customerNameInput.value.trim();
            const customerPhone = customerPhoneInput.value.trim();
            const customerAddress = customerAddressInput.value.trim();
            
            if (!customerName) {
                showMessage('សូមបញ្ចូលឈ្មោះអតិថិជន។');
                return;
            }
            if (!customerPhone) {
                showMessage('សូមបញ្ចូលលេខទូរស័ព្ទអតិថិជន។');
                return;
            }
            if (!customerAddress) {
                showMessage('សូមបញ្ចូលអាសយដ្ឋានអតិថិជន។');
                return;
            }

            try {
                const invoiceData = {
                    customerName: customerName,
                    customerPhone: customerPhone,
                    customerAddress: customerAddress,
                    deliveryOption: getDeliveryOptions(),
                    paymentOption: getPaymentOptions(),
                    paymentNotes: paymentNotesInput.value.trim(),
                    deliveryFee: parseFloat(deliveryFeeInput.value) || 0,
                    storeName: getStoreName(),
                    items: currentInvoiceItems,
                    timestamp: new Date()
                };
                
                // Save the entire invoice as a single document
                await addDoc(collection(db, `artifacts/${appId}/public/data/invoices`), invoiceData);
                
                // Get the newly generated invoice number from the sorted array
                const sortedInvoices = [...historyInvoices].sort((a, b) => b.timestamp - b.timestamp);
                const invoiceNumber = 'C' + (sortedInvoices.length + 1).toString().padStart(7, '0');

                // Print the invoice
                printInvoice(invoiceData, invoiceNumber);

                // Clear the local array after successful save and print
                currentInvoiceItems = [];
                renderSalesList();
                
                showMessage('វិក្កយបត្រត្រូវបានបោះពុម្ព និងទិន្នន័យត្រូវបានរក្សាទុកដោយជោគជ័យ។');
                
            } catch (e) {
                console.error("Error saving invoice:", e);
                showMessage('មានបញ្ហាក្នុងការរក្សាទុកវិក្កយបត្រ។');
            }
        };
        
        const reprintInvoice = async (event) => {
            const docId = event.currentTarget.dataset.docId;
            const docRef = doc(db, `artifacts/${appId}/public/data/invoices`, docId);
            try {
                const invoiceDoc = await getDoc(docRef);
                if (invoiceDoc.exists()) {
                    const invoiceData = invoiceDoc.data();
                    const sortedInvoices = [...historyInvoices].sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
                    const invoiceIndex = sortedInvoices.findIndex(inv => inv.id === docId);
                    const invoiceNumber = 'C' + (sortedInvoices.length - invoiceIndex).toString().padStart(7, '0');
                    printInvoice(invoiceData, invoiceNumber);
                } else {
                    showMessage('មិនអាចរកវិក្កយបត្រនេះឃើញទេ។');
                }
            } catch (e) {
                console.error("Error reprinting invoice:", e);
                showMessage('មានបញ្ហាក្នុងការបោះពុម្ពឡើងវិញ។');
            }
        };

        // Function to print the invoice from local data
        const printInvoice = (invoiceData, invoiceNumber) => {
            
            const now = new Date();
            const formattedDate = now.toLocaleDateString('km-KH', { year: 'numeric', month: 'long', day: 'numeric' });
            const formattedTime = now.toLocaleTimeString('km-KH', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });

            const customerName = invoiceData.customerName || "មិនមានឈ្មោះ";
            const customerPhone = invoiceData.customerPhone || "មិនមានលេខទូរស័ព្ទ";
            const customerAddress = invoiceData.customerAddress || "មិនមានអាសយដ្ឋាន";
            const deliveryOption = invoiceData.deliveryOption || "មិនបានជ្រើសរើស";
            const paymentOption = invoiceData.paymentOption || "មិនបានជ្រើសរើស";
            const paymentNotes = invoiceData.paymentNotes || "គ្មាន";
            const storeName = invoiceData.storeName;
            const salesTotal = invoiceData.items.reduce((sum, item) => sum + item.total, 0);
            const deliveryFee = invoiceData.deliveryFee || 0;
            const finalTotal = salesTotal + deliveryFee;

            // Create the invoice content HTML
            let invoiceHTML = `
                <div class="invoice-print-section" style="width: 80mm; margin: 0 auto; padding: 5mm; box-sizing: border-box;">
                    <h1 style="font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 5mm;">${storeName}</h1>
                    <div style="font-size: 14px; line-height: 1.5; margin-bottom: 5mm;">
                        <p style="margin: 0; font-weight: bold; text-align: center;">${invoiceNumber}</p>
                        <p style="margin: 0;">ឈ្មោះអតិថិជន: <strong>${customerName}</strong></p>
                        <p style="margin: 0;">លេខទូរស័ព្ទ: <strong>${customerPhone}</strong></p>
                        <p style="margin: 0;">អាសយដ្ឋាន: <strong>${customerAddress}</strong></p>
                        <p style="margin: 0;">ដឹកតាម: <strong>${deliveryOption}</strong> | ទូទាត់: <strong>${paymentOption}</strong></p>
                        <p style="margin: 0;">កំណត់សម្គាល់: <strong>${paymentNotes}</strong></p>
                        <p style="margin: 0; text-align: center;"><strong>${formattedDate} (${formattedTime})</strong></p>
                    </div>
                    <hr style="border-top: 1px dashed #000; margin-bottom: 5mm;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; font-weight: bold; padding: 2px 0;">ឈ្មោះទំនិញ</th>
                                <th style="text-align: right; font-weight: bold; padding: 2px 0; width: 10mm;">ចំនួន</th>
                                <th style="text-align: right; font-weight: bold; padding: 2px 0; width: 15mm;">តម្លៃ</th>
                                <th style="text-align: right; font-weight: bold; padding: 2px 0; width: 15mm;">សរុប</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            invoiceData.items.forEach(item => {
                invoiceHTML += `
                    <tr>
                        <td style="padding: 2px 0;">${item.name}</td>
                        <td style="text-align: right; padding: 2px 0;">${item.quantity}</td>
                        <td style="text-align: right; padding: 2px 0;">$${item.price.toFixed(2)}</td>
                        <td style="text-align: right; padding: 2px 0;">$${item.total.toFixed(2)}</td>
                    </tr>
                `;
            });

            invoiceHTML += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="text-align: right; font-weight: bold; padding-top: 5mm;">តម្លៃទំនិញសរុប:</td>
                                <td style="text-align: right; font-weight: bold; padding-top: 5mm;">$${salesTotal.toFixed(2)}</td>
                            </tr>
                             <tr>
                                <td colspan="3" style="text-align: right; font-weight: bold; padding-top: 2px;">តម្លៃសេវាដឹក:</td>
                                <td style="text-align: right; font-weight: bold; padding-top: 2px;">$${deliveryFee.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="3" style="text-align: right; font-weight: bold; padding-top: 2px;">តម្លៃសរុបទាំងអស់:</td>
                                <td style="text-align: right; font-weight: bold; padding-top: 2px;">$${finalTotal.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            // Open a new window and write the invoice HTML
            const printWindow = window.open('', '_blank', 'height=600,width=800');
            printWindow.document.write('<html><head><title>វិក្កយបត្រ</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('@page { size: 80mm auto; margin: 0; }');
            printWindow.document.write('body{font-family: Arial, sans-serif; font-size: 14px;} table{width: 100%; border-collapse: collapse;} th, td{padding: 2px 0; text-align: left;}');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(invoiceHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            
            // Clear input forms after printing
            clearFormInputs();
        };

        // Function to download data as CSV
        const downloadDataAsCsv = async () => {
            try {
                if (historyInvoices.length === 0) {
                    showMessage('គ្មានទិន្នន័យដើម្បីទាញយកទេ។');
                    return;
                }

                // Create CSV string
                const headers = ["លេខវិក្កយបត្រ", "ឈ្មោះអតិថិជន", "លេខទូរស័ព្ទ", "អាសយដ្ឋាន", "ឈ្មោះហាង", "ឈ្មោះទំនិញ", "ចំនួន", "តម្លៃ", "ផលបូក", "ជម្រើសដឹកជញ្ជូន", "ជម្រើសការទូទាត់", "កំណត់សម្គាល់", "សេវាដឹក", "កាលបរិច្ឆេទ"];
                let csv = "\uFEFF" + headers.join(',') + '\n';
                
                const sortedInvoices = [...historyInvoices].sort((a, b) => a.timestamp - b.timestamp);
                
                sortedInvoices.forEach((invoice, index) => {
                    const invoiceNumber = 'C' + (index + 1).toString().padStart(7, '0');
                    invoice.items.forEach(item => {
                        const values = [
                            `"${invoiceNumber}"`,
                            `"${invoice.customerName}"`,
                            `"${invoice.customerPhone}"`,
                            `"${invoice.customerAddress}"`,
                            `"${invoice.storeName}"`,
                            `"${item.name}"`,
                            item.quantity,
                            item.price,
                            item.total,
                            `"${invoice.deliveryOption}"`,
                            `"${invoice.paymentOption}"`,
                            `"${invoice.paymentNotes}"`,
                            invoice.deliveryFee,
                            `"${invoice.timestamp.toDate()}"`
                        ];
                        csv += values.join(',') + '\n';
                    });
                });

                // Trigger download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `ទិន្នន័យលក់_${new Date().toLocaleDateString('en-CA')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage('ការទាញយកបានចាប់ផ្តើមហើយ។');

            } catch (e) {
                console.error("Error downloading data: ", e);
                showMessage('មានបញ្ហាក្នុងការទាញយកទិន្នន័យ។ សូមព្យាយាមម្ដងទៀត។');
            }
        };

        // Function to toggle between different views
        const toggleView = (viewToShow) => {
            dashboardView.style.display = 'none';
            customerInfoView.style.display = 'none';
            historyView.style.display = 'none';

            // Reset active button styles
            [dashboardNavBtn, customerInfoNavBtn, historyNavBtn].forEach(btn => {
                btn.classList.remove('bg-white');
            });

            if (viewToShow === 'dashboard') {
                dashboardView.style.display = 'block';
                dashboardNavBtn.classList.add('bg-white');
            } else if (viewToShow === 'customerInfo') {
                customerInfoView.style.display = 'block';
                customerInfoNavBtn.classList.add('bg-white');
            } else if (viewToShow === 'history') {
                historyView.style.display = 'block';
                historyNavBtn.classList.add('bg-white');
            }
        };


        // Add event listeners to buttons
        if (addItemBtn) addItemBtn.addEventListener('click', addItem);
        if (clearFormBtn) clearFormBtn.addEventListener('click', clearFormInputs);
        
        if (printBtn) {
            printBtn.addEventListener('click', saveInvoiceToFirestoreAndPrint);
        }
        
        if (clearCurrentListBtn) {
            clearCurrentListBtn.addEventListener('click', () => {
                 showConfirmation('តើអ្នកពិតជាចង់លុបបញ្ជីបច្ចុប្បន្នមែនទេ? ការលុបនេះមិនអាចយកមកវិញបានទេ។', (result) => {
                    if (result) {
                        currentInvoiceItems = [];
                        renderSalesList();
                        clearFormInputs();
                        showMessage('បានលុបបញ្ជីបច្ចុប្បន្នដោយជោគជ័យ។');
                    }
                });
            });
        }
        
        if (downloadDataBtn) {
            downloadDataBtn.addEventListener('click', downloadDataAsCsv);
        }
        
        // Navigation button listeners
        if (dashboardNavBtn) dashboardNavBtn.addEventListener('click', () => toggleView('dashboard'));
        if (customerInfoNavBtn) customerInfoNavBtn.addEventListener('click', () => toggleView('customerInfo'));
        if (historyNavBtn) historyNavBtn.addEventListener('click', () => {
            searchQueryInput.value = '';
            renderHistoryList();
            toggleView('history');
        });

        if (startDateInput) startDateInput.addEventListener('change', updateDashboard);
        if (endDateInput) endDateInput.addEventListener('change', updateDashboard);
        
        
        // Add search functionality
        if (searchQueryInput) {
            searchQueryInput.addEventListener('input', renderHistoryList);
        }

        // Allow pressing Enter to add an item
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.id !== 'customerName' && e.target.id !== 'customerPhone' && e.target.id !== 'customerAddress') {
                addItem();
            }
        });
        
        // Add event listener to recalculate total on delivery fee change
        if (deliveryFeeInput) deliveryFeeInput.addEventListener('input', renderSalesList);

        // Dark/Light Theme Toggle
        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', () => {
                const body = document.body;
                body.classList.toggle('dark-mode');
                
                const isDarkMode = body.classList.contains('dark-mode');
                if (isDarkMode) {
                    lightIcon.style.display = 'none';
                    darkIcon.style.display = 'block';
                } else {
                    lightIcon.style.display = 'block';
                    darkIcon.style.display = 'none';
                }
            });
        }

        // Initial view load
        toggleView('dashboard');
    </script>
</body>
</html>
