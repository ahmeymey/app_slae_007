<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីគ្រប់គ្រងការលក់ប្រចាំថ្ងៃ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .invoice-print-section {
            display: none;
        }
        @media print {
            body > *:not(.invoice-print-section) {
                display: none;
            }
            .invoice-print-section {
                display: block;
                padding: 20px;
                font-family: sans-serif;
                color: #000;
            }
        }
        /* Custom modal for alerts and confirmations */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .modal-buttons {
            margin-top: 16px;
            display: flex;
            justify-content: center;
            gap: 16px;
        }
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        .invoice-row:not(:first-child) .invoice-number-cell,
        .invoice-row:not(:first-child) .customer-info-cell {
            visibility: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 p-6">

    <!-- Modal for messages -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg font-semibold text-gray-800"></p>
            <div class="modal-buttons">
                <button id="modalOkBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300">យល់ព្រម</button>
            </div>
        </div>
    </div>

    <!-- Modal for confirmations -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <p id="confirmMessage" class="text-lg font-semibold text-gray-800"></p>
            <div class="modal-buttons">
                <button id="confirmYesBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-300">បាទ/ចាស</button>
                <button id="confirmNoBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300">ទេ</button>
            </div>
        </div>
    </div>

    <!-- Loading message container -->
    <div id="loadingView" class="loading-container">
        <div class="flex flex-col items-center p-8 bg-white rounded-lg shadow-lg">
            <div class="w-16 h-16 border-4 border-t-4 border-gray-200 border-solid rounded-full animate-spin border-indigo-500"></div>
            <p class="mt-4 text-gray-700 font-semibold">កំពុងផ្ទុកទិន្នន័យ...</p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="mainApp" class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8 space-y-8 hidden">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800">កម្មវិធីគ្រប់គ្រងការលក់ Online</h1>
            <p class="text-gray-500 mt-2">កត់ត្រា និងបោះពុម្ពវិក្កយបត្រលក់</p>
        </div>

        <!-- Navigation Menu -->
        <nav class="bg-gray-200 rounded-lg p-2 flex flex-wrap justify-center sm:justify-start gap-2 sm:gap-4">
            <button id="dashboardNavBtn" class="px-4 py-2 rounded-md font-medium text-gray-700 bg-white hover:bg-gray-100 transition duration-300">
                ផ្ទាំងគ្រប់គ្រង
            </button>
            <button id="customerInfoNavBtn" class="px-4 py-2 rounded-md font-medium text-gray-700 hover:bg-gray-100 transition duration-300">
                ព័ត៌មានអតិថិជន
            </button>
            <button id="historyNavBtn" class="px-4 py-2 rounded-md font-medium text-gray-700 hover:bg-gray-100 transition duration-300">
                មើលប្រវត្តិទិន្នន័យ
            </button>
            <button id="userManagementNavBtn" class="px-4 py-2 rounded-md font-medium text-gray-700 hover:bg-gray-100 transition duration-300">
                គ្រប់គ្រងអ្នកប្រើប្រាស់
            </button>
        </nav>
        
        <!-- Dashboard View -->
        <div id="dashboardView" class="hidden">
            <div class="bg-white rounded-lg p-6 shadow-md">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">ផ្ទាំងគ្រប់គ្រង</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-indigo-50 p-6 rounded-lg shadow-sm">
                        <p class="text-sm text-indigo-700 font-medium">ចំនួនការលក់សរុប</p>
                        <p id="totalSalesCount" class="text-3xl font-bold text-indigo-800 mt-1">0</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-lg shadow-sm">
                        <p class="text-sm text-green-700 font-medium">ចំណូលសរុប (ដុល្លារ)</p>
                        <p id="totalRevenue" class="text-3xl font-bold text-green-800 mt-1">$0.00</p>
                    </div>
                    <div class="bg-yellow-50 p-6 rounded-lg shadow-sm">
                        <p class="text-sm text-yellow-700 font-medium">ចំណូលពីសេវាដឹក</p>
                        <p id="totalDeliveryFee" class="text-3xl font-bold text-yellow-800 mt-1">$0.00</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Sales Form View (now "ព័ត៌មានអតិថិជន") -->
        <div id="customerInfoView" class="hidden">
            <!-- Customer Information Form -->
            <div class="bg-gray-50 rounded-lg p-6 space-y-4">
                <h2 class="text-xl font-semibold text-gray-700">ព័ត៌មានអតិថិជន</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="customerName" class="block text-sm font-medium text-gray-700">ឈ្មោះអតិថិជន</label>
                        <input type="text" id="customerName" placeholder="ដូចជា: កញ្ញា សុភា" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    </div>
                    <div>
                        <label for="customerPhone" class="block text-sm font-medium text-gray-700">លេខទូរស័ព្ទ</label>
                        <input type="text" id="customerPhone" placeholder="012 345 678" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    </div>
                    <div class="md:col-span-1">
                        <label for="customerAddress" class="block text-sm font-medium text-gray-700">អាសយដ្ឋាន</label>
                        <input type="text" id="customerAddress" placeholder="ភូមិ X ឃុំ Y" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    </div>
                </div>
                
                <div class="mt-4">
                    <h3 class="text-sm font-medium text-gray-700">ជម្រើសហាង</h3>
                    <div class="mt-2 flex items-center space-x-4">
                        <div class="flex items-center">
                            <input id="ccrOnlineCheckbox" type="checkbox" name="store" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="ccrOnlineCheckbox" class="ml-2 block text-sm text-gray-900">CCR Online Store</label>
                        </div>
                        <div class="flex items-center">
                            <input id="yl99CcrCheckbox" type="checkbox" name="store" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="yl99CcrCheckbox" class="ml-2 block text-sm text-gray-900">YL 99CCR</label>
                        </div>
                        <div class="flex items-center">
                            <input id="ccr168Checkbox" type="checkbox" name="store" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="ccr168Checkbox" class="ml-2 block text-sm text-gray-900">CCR168</label>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <h3 class="text-sm font-medium text-gray-700">ជម្រើសសម្រាប់ការដឹកជញ្ជូន</h3>
                    <div class="mt-2 flex items-center space-x-4">
                        <div class="flex items-center">
                            <input id="vetCheckbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="vetCheckbox" class="ml-2 block text-sm text-gray-900">VET</label>
                        </div>
                        <div class="flex items-center">
                            <input id="jtCheckbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="jtCheckbox" class="ml-2 block text-sm text-gray-900">J&T</label>
                        </div>
                        <div class="flex items-center">
                            <input id="phnompenhCheckbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="phnompenhCheckbox" class="ml-2 block text-sm text-gray-900">ភ្នំពេញ</label>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <h3 class="text-sm font-medium text-gray-700">ជម្រើសការទូទាត់</h3>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <input id="acCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="acCheckbox" class="ml-2 block text-sm text-gray-900">AC</label>
                            </div>
                            <div class="flex items-center">
                                <input id="abaCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="abaCheckbox" class="ml-2 block text-sm text-gray-900">ABA</label>
                            </div>
                            <div class="flex items-center">
                                <input id="wingCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="wingCheckbox" class="ml-2 block text-sm text-gray-900">Wing</label>
                            </div>
                            <div class="flex items-center">
                                <input id="trueEmoneyCheckbox" type="checkbox" name="payment" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <label for="trueEmoneyCheckbox" class="ml-2 block text-sm text-gray-900">True Emoney</label>
                            </div>
                        </div>
                        <div>
                            <label for="paymentNotes" class="block text-sm font-medium text-gray-700 mt-2">កំណត់សម្គាល់បន្ថែម</label>
                            <input type="text" id="paymentNotes" placeholder="ដាក់លេខTxd ..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h3 class="text-sm font-medium text-gray-700">សេវាដឹក</h3>
                    <div class="mt-2">
                        <label for="deliveryFee" class="block text-sm font-medium text-gray-700">តម្លៃសេវាដឹក (ដុល្លារ)</label>
                        <input type="number" id="deliveryFee" value="0.00" min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    </div>
                </div>
            </div>

            <!-- Input Form -->
            <div class="bg-gray-50 rounded-lg p-6 space-y-4">
                <h2 class="text-xl font-semibold text-gray-700">បញ្ចូលព័ត៌មានការលក់</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="col-span-1 md:col-span-2">
                        <label for="itemName" class="block text-sm font-medium text-gray-700">ឈ្មោះទំនិញ</label>
                        <input type="text" id="itemName" placeholder="ដូចជា: ក្រែមលាបមុខ" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    </div>
                    <div>
                        <label for="itemQuantity" class="block text-sm font-medium text-gray-700">ចំនួន</label>
                        <input type="number" id="itemQuantity" value="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    </div>
                    <div>
                        <label for="itemPrice" class="block text-sm font-medium text-gray-700">តម្លៃ (ដុល្លារ)</label>
                        <input type="number" id="itemPrice" placeholder="0.00" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                    </div>
                </div>
                <div class="flex justify-end mt-4 space-x-2">
                    <button id="addItemBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-300 shadow-sm">
                        បន្ថែមទំនិញ
                    </button>
                    <button id="clearFormBtn" class="px-4 py-2 bg-gray-400 text-white rounded-md hover:bg-gray-500 transition duration-300 shadow-sm">
                        ជម្រះទិន្នន័យ
                    </button>
                </div>
            </div>

            <!-- Sales Table -->
            <div class="bg-white rounded-lg p-6 shadow-md">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">បញ្ជីការលក់</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ល.រ
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ឈ្មោះទំនិញ
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ចំនួន
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    តម្លៃ
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ផលបូក
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    លុប
                                </th>
                            </tr>
                        </thead>
                        <tbody id="salesList" class="bg-white divide-y divide-gray-200">
                            <!-- Sales items will be inserted here by JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-50">
                                <td colspan="4" class="px-6 py-4 whitespace-nowrap text-right text-base font-bold text-gray-900">
                                    សរុប:
                                </td>
                                <td id="totalAmount" class="px-6 py-4 whitespace-nowrap text-left text-base font-bold text-gray-900">
                                    $0.00
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <!-- Action Buttons for Customer Info View -->
            <div class="flex justify-center md:justify-end space-x-4 mt-6">
                <button id="printBtn" class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-300 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v9a2 2 0 002 2h12a2 2 0 002-2v-9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm2 5V4h6v5H7zm6 3H7v4h6v-4z" clip-rule="evenodd" />
                    </svg>
                    បោះពុម្ពវិក្កយបត្រ
                </button>
                <button id="clearCurrentListBtn" class="px-6 py-3 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-300 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-8a1 1 0 112 0v5a1 1 0 11-2 0v-5z" clip-rule="evenodd" />
                    </svg>
                    ជម្រះបញ្ជីបច្ចុប្បន្ន
                </button>
            </div>
        </div>

        <!-- Data History View -->
        <div id="historyView" class="hidden">
            <div class="bg-white rounded-lg p-6 shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">ប្រវត្តិទិន្នន័យ</h2>
                </div>
                 <div class="mb-4">
                    <label for="searchQuery" class="block text-sm font-medium text-gray-700">ស្វែងរក</label>
                    <input type="text" id="searchQuery" placeholder="ស្វែងរកតាមលេខវិក្កយបត្រ ឈ្មោះអតិថិជន លេខទូរស័ព្ទ ឬអាសយដ្ឋាន..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2">
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    លេខវិក្កយបត្រ
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ឈ្មោះអតិថិជន
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    លេខទូរស័ព្ទ
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    អាសយដ្ឋាន
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ឈ្មោះទំនិញ
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ចំនួន
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    តម្លៃ
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ផលបូក
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    ជម្រើស
                                </th>
                            </tr>
                        </thead>
                        <tbody id="historyList" class="bg-white divide-y divide-gray-200">
                            <!-- History items will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <!-- Action Buttons for History View -->
                <div class="flex justify-center md:justify-end space-x-4 mt-6">
                    <button id="downloadDataBtn" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300 shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        ទាញយកទិន្នន័យ
                    </button>
                </div>
            </div>
        </div>

        <!-- User Management View -->
        <div id="userManagementView" class="hidden">
            <div class="bg-white rounded-lg p-6 shadow-md text-center">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">គ្រប់គ្រងអ្នកប្រើប្រាស់</h2>
                <p class="text-gray-600 mb-4">
                    មុខងារគ្រប់គ្រងអ្នកប្រើប្រាស់ (ដូចជាការបន្ថែម ឬលុបអ្នកប្រើប្រាស់) មិនអាចធ្វើបាននៅក្នុងកម្មវិធីនេះទេ ព្រោះទិន្នន័យរបស់អ្នកត្រូវបានរក្សាទុកជាសាធារណៈ (Public) ដើម្បីងាយស្រួលប្រើប្រាស់ជាក្រុម។
                </p>
                <p class="text-gray-600">
                    ដើម្បីបង្កើតមុខងារគ្រប់គ្រងអ្នកប្រើប្រាស់ពេញលេញ ដែលមានសុវត្ថិភាពសម្រាប់អ្នកប្រើប្រាស់ម្នាក់ៗ និងតម្រូវឲ្យមានគណនីសម្ងាត់ (Private), អ្នកត្រូវកែប្រែរចនាសម្ព័ន្ធកម្មវិធីទាំងមូល។
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');
        
        // --- Firebase Setup ---
        const firebaseConfig = {
  apiKey: "AIzaSyD_UEHdWQzxiuktfKZZEl3tb5OmYLTIGqc",
  authDomain: "my-sales-app-f43e3.firebaseapp.com",
  projectId: "my-sales-app-f43e3",
  storageBucket: "my-sales-app-f43e3.firebasestorage.app",
  messagingSenderId: "656378741429",
  appId: "1:656378741429:web:08d71364082a75e8aff4fc"
};

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let unsubscribe = null;
        let historyInvoices = []; // Now stores grouped invoices
        let currentInvoiceItems = [];

        const mainApp = document.getElementById('mainApp');
        const loadingView = document.getElementById('loadingView');

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        async function authenticateAndLoad() {
            loadingView.style.display = 'flex';
            mainApp.style.display = 'none';
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Use a public collection for all users
                const invoicesCollectionRef = collection(db, `artifacts/${appId}/public/data/invoices`);
                const q = query(invoicesCollectionRef);
                unsubscribe = onSnapshot(q, (querySnapshot) => {
                    historyInvoices = [];
                    querySnapshot.forEach((doc) => {
                        historyInvoices.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    renderHistoryList();
                    updateDashboard();

                    // Hide loading and show main app after data is loaded
                    loadingView.style.display = 'none';
                    mainApp.style.display = 'block';
                });
            } catch (error) {
                console.error("Firebase Auth or Firestore error:", error);
                loadingView.style.display = 'none';
                mainApp.style.display = 'block';
                showMessage('មានបញ្ហាក្នុងការផ្ទុកទិន្នន័យ។ សូមព្យាយាមម្ដងទៀត។');
            }
        }
        authenticateAndLoad();

        // --- Modal/Message Box Functions ---
        const messageModal = document.getElementById('messageModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalOkBtn = document.getElementById('modalOkBtn');
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');
        let confirmationCallback = null;

        const showMessage = (message) => {
            modalMessage.textContent = message;
            messageModal.style.display = 'flex';
        };

        const showConfirmation = (message, callback) => {
            confirmMessage.textContent = message;
            confirmationCallback = callback;
            confirmModal.style.display = 'flex';
        };

        if(modalOkBtn) {
            modalOkBtn.addEventListener('click', () => {
                messageModal.style.display = 'none';
            });
        }

        if(confirmYesBtn) {
            confirmYesBtn.addEventListener('click', () => {
                confirmModal.style.display = 'none';
                if (confirmationCallback) {
                    confirmationCallback(true);
                }
            });
        }
        if(confirmNoBtn) {
            confirmNoBtn.addEventListener('click', () => {
                confirmModal.style.display = 'none';
                if (confirmationCallback) {
                    confirmationCallback(false);
                }
            });
        }


        // Get all necessary HTML elements
        const dashboardView = document.getElementById('dashboardView');
        const customerInfoView = document.getElementById('customerInfoView');
        const historyView = document.getElementById('historyView');
        const userManagementView = document.getElementById('userManagementView');
        
        const customerNameInput = document.getElementById('customerName');
        const customerPhoneInput = document.getElementById('customerPhone');
        const customerAddressInput = document.getElementById('customerAddress');
        const ccrOnlineCheckbox = document.getElementById('ccrOnlineCheckbox');
        const yl99CcrCheckbox = document.getElementById('yl99CcrCheckbox');
        const ccr168Checkbox = document.getElementById('ccr168Checkbox');
        const vetCheckbox = document.getElementById('vetCheckbox');
        const jtCheckbox = document.getElementById('jtCheckbox');
        const phnompenhCheckbox = document.getElementById('phnompenhCheckbox');
        const acCheckbox = document.getElementById('acCheckbox');
        const abaCheckbox = document.getElementById('abaCheckbox');
        const wingCheckbox = document.getElementById('wingCheckbox');
        const trueEmoneyCheckbox = document.getElementById('trueEmoneyCheckbox');
        const paymentNotesInput = document.getElementById('paymentNotes');
        const deliveryFeeInput = document.getElementById('deliveryFee');
        const itemNameInput = document.getElementById('itemName');
        const itemQuantityInput = document.getElementById('itemQuantity');
        const itemPriceInput = document.getElementById('itemPrice');
        const addItemBtn = document.getElementById('addItemBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const salesListBody = document.getElementById('salesList');
        const historyListBody = document.getElementById('historyList');
        const totalAmountDisplay = document.getElementById('totalAmount');
        const printBtn = document.getElementById('printBtn');
        const clearCurrentListBtn = document.getElementById('clearCurrentListBtn');
        const downloadDataBtn = document.getElementById('downloadDataBtn');
        const searchQueryInput = document.getElementById('searchQuery');
        
        const totalSalesCountDisplay = document.getElementById('totalSalesCount');
        const totalRevenueDisplay = document.getElementById('totalRevenue');
        const totalDeliveryFeeDisplay = document.getElementById('totalDeliveryFee');

        // Navigation buttons
        const dashboardNavBtn = document.getElementById('dashboardNavBtn');
        const customerInfoNavBtn = document.getElementById('customerInfoNavBtn');
        const historyNavBtn = document.getElementById('historyNavBtn');
        const userManagementNavBtn = document.getElementById('userManagementNavBtn');

        // Function to handle exclusive checkbox selection for store names
        const handleStoreSelection = (selectedCheckbox) => {
            [ccrOnlineCheckbox, yl99CcrCheckbox, ccr168Checkbox].forEach(checkbox => {
                if (checkbox !== selectedCheckbox) {
                    checkbox.checked = false;
                }
            });
        };

        // Function to handle exclusive checkbox selection for payment methods
        const handlePaymentSelection = (selectedCheckbox) => {
            [acCheckbox, abaCheckbox, wingCheckbox, trueEmoneyCheckbox].forEach(checkbox => {
                if (checkbox !== selectedCheckbox) {
                    checkbox.checked = false;
                }
            });
        };

        if (ccrOnlineCheckbox) ccrOnlineCheckbox.addEventListener('change', () => handleStoreSelection(ccrOnlineCheckbox));
        if (yl99CcrCheckbox) yl99CcrCheckbox.addEventListener('change', () => handleStoreSelection(yl99CcrCheckbox));
        if (ccr168Checkbox) ccr168Checkbox.addEventListener('change', () => handleStoreSelection(ccr168Checkbox));
        if (acCheckbox) acCheckbox.addEventListener('change', () => handlePaymentSelection(acCheckbox));
        if (abaCheckbox) abaCheckbox.addEventListener('change', () => handlePaymentSelection(abaCheckbox));
        if (wingCheckbox) wingCheckbox.addEventListener('change', () => handlePaymentSelection(wingCheckbox));
        if (trueEmoneyCheckbox) trueEmoneyCheckbox.addEventListener('change', () => handlePaymentSelection(trueEmoneyCheckbox));


        // Function to add a new item to the local sales list
        const addItem = () => {
            const name = itemNameInput.value.trim();
            const quantity = parseFloat(itemQuantityInput.value);
            const price = parseFloat(itemPriceInput.value);
            const deliveryFee = parseFloat(deliveryFeeInput.value) || 0;

            if (!name || isNaN(quantity) || isNaN(price) || quantity <= 0 || price <= 0) {
                showMessage('សូមបញ្ចូលព័ត៌មានទំនិញឲ្យបានគ្រប់គ្រាន់ និងត្រឹមត្រូវ។');
                return;
            }

            const total = quantity * price;
            currentInvoiceItems.push({
                name,
                quantity,
                price,
                total,
                customerName: customerNameInput.value.trim(),
                customerPhone: customerPhoneInput.value.trim(),
                customerAddress: customerAddressInput.value.trim(),
                deliveryOption: getDeliveryOptions(),
                paymentOption: getPaymentOptions(),
                paymentNotes: paymentNotesInput.value.trim(),
                deliveryFee: deliveryFee,
                storeName: getStoreName(),
                timestamp: new Date()
            });
            
            // Clear the input fields after successful addition
            itemNameInput.value = '';
            itemQuantityInput.value = '1';
            itemPriceInput.value = '';
            itemNameInput.focus();
            
            renderSalesList();
        };

        // Function to render the current sales list table
        const renderSalesList = () => {
            salesListBody.innerHTML = '';
            let totalAmount = 0;
            currentInvoiceItems.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${item.price.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${item.total.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="delete-item-local text-red-600 hover:text-red-900" data-index="${index}">លុប</button>
                    </td>
                `;
                salesListBody.appendChild(row);
                totalAmount += item.total;
            });
            
            const deliveryFee = parseFloat(deliveryFeeInput.value) || 0;
            totalAmountDisplay.textContent = `$${(totalAmount + deliveryFee).toFixed(2)}`;

            // Add event listeners to the new delete buttons
            document.querySelectorAll('.delete-item-local').forEach(button => {
                button.addEventListener('click', deleteLocalItem);
            });
        };
        
        // Function to delete an item from the local array
        const deleteLocalItem = (e) => {
            const index = e.target.dataset.index;
            currentInvoiceItems.splice(index, 1);
            renderSalesList();
        };
        
        // Function to render the history list table
        const renderHistoryList = () => {
            const query = searchQueryInput.value.toLowerCase();
            const filteredInvoices = historyInvoices.filter(invoice => {
                const invoiceNumber = 'C' + (historyInvoices.length - historyInvoices.indexOf(invoice)).toString().padStart(7, '0');
                const customerName = (invoice.customerName || '').toLowerCase();
                const customerPhone = (invoice.customerPhone || '').toLowerCase();
                const customerAddress = (invoice.customerAddress || '').toLowerCase();
                
                return invoiceNumber.includes(query) ||
                       customerName.includes(query) ||
                       customerPhone.includes(query) ||
                       customerAddress.includes(query);
            });
            
            historyListBody.innerHTML = '';
            
            filteredInvoices.sort((a, b) => b.timestamp - a.timestamp);

            filteredInvoices.forEach((invoice, invoiceIndex) => {
                const invoiceNumber = 'C' + (historyInvoices.length - historyInvoices.indexOf(invoice)).toString().padStart(7, '0');
                
                invoice.items.forEach((item, itemIndex) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    if (itemIndex === 0) {
                        row.classList.add('invoice-row');
                    }
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 invoice-number-cell">${invoiceNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 customer-info-cell">${invoice.customerName || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 customer-info-cell">${invoice.customerPhone || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 customer-info-cell">${invoice.customerAddress || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${item.price.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${item.total.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="delete-item-db text-red-600 hover:text-red-900" data-doc-id="${invoice.id}">លុបវិក្កយបត្រ</button>
                        </td>
                    `;
                    historyListBody.appendChild(row);
                });
            });

            if (filteredInvoices.length === 0 && query.length > 0) {
                historyListBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-4 text-center text-gray-500">
                            រកមិនឃើញលទ្ធផលសម្រាប់ "${query}"
                        </td>
                    </tr>
                `;
            }
            
            // Add event listeners to the new delete buttons
            document.querySelectorAll('.delete-item-db').forEach(button => {
                button.addEventListener('click', deleteItemFromDB);
            });
        };
        
        // Function to delete an item from the database
        const deleteItemFromDB = async (e) => {
            const docId = e.target.dataset.docId;
            try {
                showConfirmation('តើអ្នកពិតជាចង់លុបវិក្កយបត្រនេះមែនទេ? ការលុបនេះមិនអាចយកមកវិញបានទេ។', async (result) => {
                    if (result) {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/invoices`, docId));
                        showMessage('បានលុបវិក្កយបត្រដោយជោគជ័យ។');
                    }
                });
            } catch (e) {
                console.error("Error removing document: ", e);
                showMessage('មានបញ្ហាក្នុងការលុបទិន្នន័យ។ សូមព្យាយាមម្ដងទៀត។');
            }
        };

        // Function to update all dashboard metrics
        const updateDashboard = () => {
            let totalSalesCount = 0;
            let totalRevenue = 0;
            let totalDeliveryFee = 0;

            historyInvoices.forEach(invoice => {
                invoice.items.forEach(item => {
                    totalSalesCount++;
                    totalRevenue += item.total;
                });
                totalDeliveryFee += invoice.deliveryFee;
            });
            
            totalSalesCountDisplay.textContent = totalSalesCount;
            totalRevenueDisplay.textContent = `$${totalRevenue.toFixed(2)}`;
            totalDeliveryFeeDisplay.textContent = `$${totalDeliveryFee.toFixed(2)}`;
        };
        
        // Helper functions for getting checkbox values
        const getStoreName = () => {
            if (ccrOnlineCheckbox.checked) return 'CCR Online Store';
            if (yl99CcrCheckbox.checked) return 'YL 99CCR';
            if (ccr168Checkbox.checked) return 'CCR168';
            return 'វិក្កយបត្រ';
        };

        const getDeliveryOptions = () => {
            let options = [];
            if (vetCheckbox.checked) options.push('VET');
            if (jtCheckbox.checked) options.push('J&T');
            if (phnompenhCheckbox.checked) options.push('ភ្នំពេញ');
            return options.join(', ') || 'មិនបានជ្រើសរើស';
        };

        const getPaymentOptions = () => {
            let options = [];
            if (acCheckbox.checked) options.push('AC');
            if (abaCheckbox.checked) options.push('ABA');
            if (wingCheckbox.checked) options.push('Wing');
            if (trueEmoneyCheckbox.checked) options.push('True Emoney');
            return options.join(', ') || 'មិនបានជ្រើសរើស';
        };

        // Function to clear input forms
        const clearFormInputs = () => {
            customerNameInput.value = '';
            customerPhoneInput.value = '';
            customerAddressInput.value = '';
            vetCheckbox.checked = false;
            jtCheckbox.checked = false;
            phnompenhCheckbox.checked = false;
            ccrOnlineCheckbox.checked = false;
            yl99CcrCheckbox.checked = false;
            ccr168Checkbox.checked = false;
            acCheckbox.checked = false;
            abaCheckbox.checked = false;
            wingCheckbox.checked = false;
            trueEmoneyCheckbox.checked = false;
            paymentNotesInput.value = '';
            deliveryFeeInput.value = '0.00';
            itemNameInput.value = '';
            itemQuantityInput.value = '1';
            itemPriceInput.value = '';
            itemNameInput.focus();
        };

        // Function to save invoice to database and then clear the local list
        const saveInvoiceToFirestoreAndPrint = async () => {
            if (currentInvoiceItems.length === 0) {
                showMessage('សូមបន្ថែមទំនិញយ៉ាងតិចមួយមុខដើម្បីបោះពុម្ព។');
                return;
            }
            
            const customerName = customerNameInput.value.trim();
            const customerPhone = customerPhoneInput.value.trim();
            const customerAddress = customerAddressInput.value.trim();
            
            if (!customerName) {
                showMessage('សូមបញ្ចូលឈ្មោះអតិថិជន។');
                return;
            }
            if (!customerPhone) {
                showMessage('សូមបញ្ចូលលេខទូរស័ព្ទអតិថិជន។');
                return;
            }
            if (!customerAddress) {
                showMessage('សូមបញ្ចូលអាសយដ្ឋានអតិថិជន។');
                return;
            }

            try {
                const invoiceData = {
                    customerName: customerName,
                    customerPhone: customerPhone,
                    customerAddress: customerAddress,
                    deliveryOption: getDeliveryOptions(),
                    paymentOption: getPaymentOptions(),
                    paymentNotes: paymentNotesInput.value.trim(),
                    deliveryFee: parseFloat(deliveryFeeInput.value) || 0,
                    storeName: getStoreName(),
                    items: currentInvoiceItems,
                    timestamp: new Date()
                };
                
                // Save the entire invoice as a single document
                await addDoc(collection(db, `artifacts/${appId}/public/data/invoices`), invoiceData);
                
                // Print the invoice
                printInvoice();

                // Clear the local array after successful save and print
                currentInvoiceItems = [];
                renderSalesList();
                
                showMessage('វិក្កយបត្រត្រូវបានបោះពុម្ព និងទិន្នន័យត្រូវបានរក្សាទុកដោយជោគជ័យ។');
                
            } catch (e) {
                console.error("Error saving invoice:", e);
                showMessage('មានបញ្ហាក្នុងការរក្សាទុកវិក្កយបត្រ។');
            }
        };

        // Function to print the invoice from local data
        const printInvoice = () => {
            if (currentInvoiceItems.length === 0) {
                return; // Prevent printing empty invoice
            }
            
            const now = new Date();
            const formattedDate = now.toLocaleDateString('km-KH', { year: 'numeric', month: 'long', day: 'numeric' });
            const formattedTime = now.toLocaleTimeString('km-KH', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });

            const firstItem = currentInvoiceItems[0];
            const customerName = firstItem.customerName || "មិនមានឈ្មោះ";
            const customerPhone = firstItem.customerPhone || "មិនមានលេខទូរស័ព្ទ";
            const customerAddress = firstItem.customerAddress || "មិនមានអាសយដ្ឋាន";
            const deliveryOption = firstItem.deliveryOption || "មិនបានជ្រើសរើស";
            const paymentOption = firstItem.paymentOption || "មិនបានជ្រើសរើស";
            const paymentNotes = firstItem.paymentNotes || "គ្មាន";
            const storeName = firstItem.storeName || "វិក្កយបត្រ";
            const salesTotal = currentInvoiceItems.reduce((sum, item) => sum + item.total, 0);
            const deliveryFee = parseFloat(deliveryFeeInput.value) || 0;
            const finalTotal = salesTotal + deliveryFee;

            // Create the invoice content HTML
            let invoiceHTML = `
                <div class="p-8">
                    <h1 class="text-2xl font-bold text-center mb-4">${storeName}</h1>
                    <div class="text-sm mb-4">
                        <p><strong>ឈ្មោះអតិថិជន:</strong> ${customerName} | <strong>លេខទូរស័ព្ទ:</strong> ${customerPhone}</p>
                        <p><strong>អាសយដ្ឋាន:</strong> ${customerAddress}</p>
                        <p><strong>ជម្រើសដឹកជញ្ជូន:</strong> ${deliveryOption} | <strong>ជម្រើសការទូទាត់:</strong> ${paymentOption}</p>
                        <p><strong>កំណត់សម្គាល់:</strong> ${paymentNotes}</p>
                        <p><strong>ថ្ងៃខែឆ្នាំ:</strong> ${formattedDate} (${formattedTime})</p>
                    </div>
                    <hr class="mb-4">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th class="text-left">ឈ្មោះទំនិញ</th>
                                <th class="text-right">ចំនួន</th>
                                <th class="text-right">តម្លៃ</th>
                                <th class="text-right">សរុប</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            currentInvoiceItems.forEach(item => {
                invoiceHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td class="text-right">${item.quantity}</td>
                        <td class="text-right">$${item.price.toFixed(2)}</td>
                        <td class="text-right">$${item.total.toFixed(2)}</td>
                    </tr>
                `;
            });

            invoiceHTML += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-right font-bold pt-4">តម្លៃទំនិញសរុប:</td>
                                <td class="text-right font-bold pt-4">$${salesTotal.toFixed(2)}</td>
                            </tr>
                             <tr>
                                <td colspan="3" class="text-right font-bold pt-4">តម្លៃសេវាដឹក:</td>
                                <td class="text-right font-bold pt-4">$${deliveryFee.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="3" class="text-right font-bold pt-4">តម្លៃសរុបទាំងអស់:</td>
                                <td class="text-right font-bold pt-4">$${finalTotal.toFixed(2)}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            // Open a new window and write the invoice HTML
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>វិក្កយបត្រ</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('body{font-family: Arial, sans-serif; font-size: 14px;} table{width: 100%; border-collapse: collapse;} th, td{border: 1px solid #ddd; padding: 8px; text-align: left;}');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(invoiceHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            
            // Clear input forms after printing
            clearFormInputs();
        };

        // Function to download data as CSV
        const downloadDataAsCsv = async () => {
            try {
                if (historyInvoices.length === 0) {
                    showMessage('គ្មានទិន្នន័យដើម្បីទាញយកទេ។');
                    return;
                }

                // Create CSV string
                const headers = ["លេខវិក្កយបត្រ", "ឈ្មោះអតិថិជន", "លេខទូរស័ព្ទ", "អាសយដ្ឋាន", "ឈ្មោះហាង", "ឈ្មោះទំនិញ", "ចំនួន", "តម្លៃ", "ផលបូក", "ជម្រើសដឹកជញ្ជូន", "ជម្រើសការទូទាត់", "កំណត់សម្គាល់", "សេវាដឹក", "កាលបរិច្ឆេទ"];
                let csv = headers.join(',') + '\n';
                
                const sortedInvoices = [...historyInvoices].sort((a, b) => a.timestamp - b.timestamp);
                
                sortedInvoices.forEach((invoice, index) => {
                    const invoiceNumber = 'C' + (index + 1).toString().padStart(7, '0');
                    invoice.items.forEach(item => {
                        const values = [
                            `"${invoiceNumber}"`,
                            `"${invoice.customerName}"`,
                            `"${invoice.customerPhone}"`,
                            `"${invoice.customerAddress}"`,
                            `"${invoice.storeName}"`,
                            `"${item.name}"`,
                            item.quantity,
                            item.price,
                            item.total,
                            `"${invoice.deliveryOption}"`,
                            `"${invoice.paymentOption}"`,
                            `"${invoice.paymentNotes}"`,
                            invoice.deliveryFee,
                            `"${invoice.timestamp.toDate()}"`
                        ];
                        csv += values.join(',') + '\n';
                    });
                });

                // Trigger download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `ទិន្នន័យលក់_${new Date().toLocaleDateString('en-CA')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage('ការទាញយកបានចាប់ផ្តើមហើយ។');

            } catch (e) {
                console.error("Error downloading data: ", e);
                showMessage('មានបញ្ហាក្នុងការទាញយកទិន្នន័យ។ សូមព្យាយាមម្ដងទៀត។');
            }
        };

        // Function to toggle between different views
        const toggleView = (viewToShow) => {
            dashboardView.style.display = 'none';
            customerInfoView.style.display = 'none';
            historyView.style.display = 'none';
            userManagementView.style.display = 'none';

            // Reset active button styles
            [dashboardNavBtn, customerInfoNavBtn, historyNavBtn, userManagementNavBtn].forEach(btn => {
                btn.classList.remove('bg-white');
            });

            if (viewToShow === 'dashboard') {
                dashboardView.style.display = 'block';
                dashboardNavBtn.classList.add('bg-white');
            } else if (viewToShow === 'customerInfo') {
                customerInfoView.style.display = 'block';
                customerInfoNavBtn.classList.add('bg-white');
            } else if (viewToShow === 'history') {
                historyView.style.display = 'block';
                historyNavBtn.classList.add('bg-white');
            } else if (viewToShow === 'userManagement') {
                userManagementView.style.display = 'block';
                userManagementNavBtn.classList.add('bg-white');
            }
        };


        // Add event listeners to buttons
        if (addItemBtn) addItemBtn.addEventListener('click', addItem);
        if (clearFormBtn) clearFormBtn.addEventListener('click', clearFormInputs);
        
        if (printBtn) {
            printBtn.addEventListener('click', saveInvoiceToFirestoreAndPrint);
        }
        
        if (clearCurrentListBtn) {
            clearCurrentListBtn.addEventListener('click', () => {
                 showConfirmation('តើអ្នកពិតជាចង់លុបបញ្ជីបច្ចុប្បន្នមែនទេ? ការលុបនេះមិនអាចយកមកវិញបានទេ។', (result) => {
                    if (result) {
                        currentInvoiceItems = [];
                        renderSalesList();
                        clearFormInputs();
                        showMessage('បានលុបបញ្ជីបច្ចុប្បន្នដោយជោគជ័យ។');
                    }
                });
            });
        }
        
        if (downloadDataBtn) {
            downloadDataBtn.addEventListener('click', downloadDataAsCsv);
        }
        
        // Navigation button listeners
        if (dashboardNavBtn) dashboardNavBtn.addEventListener('click', () => toggleView('dashboard'));
        if (customerInfoNavBtn) customerInfoNavBtn.addEventListener('click', () => toggleView('customerInfo'));
        if (historyNavBtn) historyNavBtn.addEventListener('click', () => {
            searchQueryInput.value = '';
            renderHistoryList();
            toggleView('history');
        });
        if (userManagementNavBtn) userManagementNavBtn.addEventListener('click', () => toggleView('userManagement'));

        // Add search functionality
        if (searchQueryInput) {
            searchQueryInput.addEventListener('input', renderHistoryList);
        }

        // Allow pressing Enter to add an item
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.id !== 'customerName' && e.target.id !== 'customerPhone' && e.target.id !== 'customerAddress') {
                addItem();
            }
        });
        
        // Add event listener to recalculate total on delivery fee change
        if (deliveryFeeInput) deliveryFeeInput.addEventListener('input', renderSalesList);

        // Initial view load
        toggleView('dashboard');
    </script>
</body>
</html>
